name: Create branches in multiple repos

on:
  workflow_dispatch:
    inputs:
      jira_key:
        description: "Jira issue key (e.g. ABC-123)"
        required: true
      repos:
        description: "Comma-separated repos (org/repo1,org/repo2)"
        required: true
      base_branch:
        description: "Base branch"
        required: false
        default: "main"

jobs:
  create-branches:
    runs-on: ubuntu-latest

    steps:
      - name: Create branches
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          JIRA_KEY: ${{ github.event.inputs.jira_key }}
          REPOS: ${{ github.event.inputs.repos }}
          BASE_BRANCH: ${{ github.event.inputs.base_branch }}
        run: |
          set -e

          BRANCH_NAME="feature/${JIRA_KEY}"
          IFS=',' read -ra REPO_LIST <<< "$REPOS"

          for REPO in "${REPO_LIST[@]}"; do
            echo "Processing $REPO"

            BASE_SHA=$(curl -s \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/$REPO/git/ref/heads/$BASE_BRANCH \
              | jq -r .object.sha)

            if [ "$BASE_SHA" = "null" ]; then
              echo "Base branch not found in $REPO"
              continue
            fi

            curl -s -X POST \
              -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/$REPO/git/refs \
              -d "{\"ref\":\"refs/heads/$BRANCH_NAME\",\"sha\":\"$BASE_SHA\"}"

            echo "Branch $BRANCH_NAME created in $REPO"
          done
